<p>The purpose of this blog post is to detail physical standby database creation in the following configuration:</p>
<li> Oracle Linux 6.5 64-bit with VirtualBox 4.3.16</li>
<li> Oracle Grid Infrastructure (GI) 12.1.0.2: database storage is using ASM so Oracle Managed Files (OMF) are automatically used</li>
<li> Oracle Database Entreprise Edition 12.1.0.2.</li>
<li> Primary database is a multitenant database named <b>cdb0</b> with 2 pluggable databases pdb1 and pdb2.</li>
<p>UPDATED 03-JAN-2015: I have updated this blog post to have all instance names and database names uppercase. I have also deferred setting LOG_ARCHIVE_DEST_STATE_2 on primary.</p>
<p>Hostnames and database identifiers are detailed in the following table (0 means primary and 1 means standby):</p>
<table border="2">
<tr>
<th></th>
<th>primary</th>
<th>standby</th>
</tr>
<tr>
<td>hostname</td>
<td>ol6twsa0</td>
<td>ol6twsa1</td>
</tr>
<tr>
<td>DB_NAME</td>
<td>CDB0</td>
<td>CDB0<br />
</tr>
<tr>
<td>DB_UNIQUE_NAME</td>
<td>CDB0</td>
<td>CDB1</td>
</tr>
<tr>
<td>datafile disk group name</td>
<td>+DATA</td>
<td>+DATA</td>
</tr>
<tr>
<td>fast recovery area disk group name</td>
<td>+FRA</td>
<td>+FRA</td>
</tr>
</table>
<p>
Note that we need to have DB_UNIQUE_NAME different from DB_NAME for standby database because this is used by Data Guard to identify each database that must have the same DB_NAME.<br />
</p>
<h3>Linux configuration</h3>
<p>You need to enable network connectivity between primary and standby machines. In this configuration I have not used DNS so I have added entries for primary and standby machines to <b>/etc/hosts</b> on both machines:</p>
<pre>
# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
#
192.168.56.76   ol6twsa0 ol6twsa0.localdomain
192.168.56.77   ol6twsa1 ol6twsa1.localdomain
</pre>
<p>You need also to configure or disable iptables (if not Oracle Net may report ORA-12543 when trying to connect from primary database to standby database):</p>
<pre>
ORA-12543: TNS:destination host unreachable
</pre>
<p>I have disabled iptables on both machines with root user:</p>
<pre>
# chkconfig --list iptables
iptables        0:off   1:off   2:on    3:on    4:on    5:on    6:off
# chkconfig iptables off
# chkconfig --list iptables
iptables        0:off   1:off   2:off   3:off   4:off   5:off   6:off
# service iptables stop
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Unloading modules:                               [  OK  ]
</pre>
<h3>Oracle Net configuration</h3>
<p>On both nodes, add Oracle Net aliases for both databases and aux alias for RMAN DUPLICATE in Oracle Database home <b>tnsnames.ora</b>:</p>
<pre>
CDB1 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ol6twsa1)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = CDB1)
    )
  )

CDB0 =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ol6twsa0)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = CDB0)
    )
  )

AUX =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ol6twsa1)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = AUX)
    )
  )


</pre>
<h3>SQL*Plus configuration</h3>
<p>In order to have the instance name displayed in SQL*Plus prompt with the current user, add in <b>/home/oracle/.bash_profile</b>:</p>
<pre>
export SQLPATH=/home/oracle/scripts
</pre>
<p>and create <b>/home/oracle/scripts/login.sql</b> with:</p>
<pre>
set sqlprompt "&amp;&amp;_USER@&amp;&amp;_CONNECT_IDENTIFIER&gt;"
</pre>
<h3>Put primary database in ARCHIVELOG mode </h3>
<pre>
$ srvctl stop database -d CDB0
$ srvctl start database -d CDB0 -o mount
$ sqlplus / as sysdba

SQL*Plus: Release 12.1.0.2.0 Production on Wed Dec 24 14:11:08 2014

Copyright (c) 1982, 2014, Oracle.  All rights reserved.


Connected to:
Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, Automatic Storage Management, OLAP, Advanced Analytics
and Real Application Testing options

SYS@CDB0&gt;alter database archivelog;

Database altered.

SYS@CDB0&gt;alter database open;

Database altered.

SYS@CDB0&gt;

</pre>
<h3>Put primary database in force logging mode</h3>
<pre>

SYS@CDB0&gt;select force_logging from v$database;

FORCE_LOGGING
---------------------------------------
NO

SYS@CDB0&gt;alter database force logging;

Database altered.

SYS@CDB0&gt;select force_logging from v$database;

FORCE_LOGGING
---------------------------------------
YES

SYS@CDB0&gt;

</pre>
<h3>Set LOG_ARCHIVE_CONFIG and LOG_ARCHIVE_DEST_2 instance parameters on primary database</h3>
<pre>
SYS@CDB0&gt;alter system set log_archive_config='dg_config=(CDB0,CDB1)';

System altered.

SYS@CDB0&gt;alter system set log_archive_dest_state_2=defer;

System altered.

SYS@CDB0&gt;alter system set log_archive_dest_2='service=CDB1 lgwr sync valid_for=(online_logfiles,primary_role) db_unique_name=CDB1';

System altered.

SYS@CDB0&gt;alter system set standby_file_management=auto;

System altered.

SYS@CDB0&gt;

</pre>
<p>Note that setting LOG_ARCHIVE_DEST_STATE_2 to defer will avoid periodic errors (12514 and TNS-12564) in primary instance alert log because by default if LOG_ARCHIVE_DEST_STATE_2 is set to ENABLED then primary instance cannot connect to standby instance which is not yet available.</p>
<h3>Create primary database password file if needed and copy it to standby machine</h3>
<p>This assumes that ORACLE_HOME is the same on primary and standby machines.</p>
<pre>
$ orapwd file=$ORACLE_HOME/dbs/orapwCDB0 password=oracle12c
$ scp $ORACLE_HOME/dbs/orapwCDB0 ol6twsa1:$ORACLE_HOME/dbs/orapwCDB1
oracle@ol6twsa1's password:
orapwCDB0                  
</pre>
<h3>Set FAL_SERVER and FAL_CLIENT server on primary database</h3>
<pre>
SYS@CDB0&gt;alter system set fal_server=CDB1;

System altered.

SYS@CDB0&gt;alter system set fal_client=CDB0;

System altered.

SYS@CDB0&gt;

</pre>
<h3> Create standby redo logs on primary database</h3>
<p>Add 1 to existing number of online redo logs group (database has been created with default DBCA so database has 3 50 MB redo log groups):</p>
<pre>
SYS@CDB0&gt;alter database add standby logfile '+FRA' size 50M;

Database altered.

SYS@CDB0&gt;/

Database altered.

SYS@CDB0&gt;/

Database altered.

SYS@CDB0&gt;/

Database altered.

</pre>
<h3>Add static service for standby instance in GI Oracle Home listener.ora on standby machine</h3>
<p>This is required by RMAN ACTIVE DUPLICATE that needs to use an Oracle Net connection to connect to auxiliary database instance. You need to use GLOBAL_DBNAME to set an Oracle Net alias different from SID_NAME:</p>
<pre>
SID_LIST_LISTENER =
 (SID_LIST =
   (SID_DESC =
     (GLOBAL_DBNAME = AUX)
     (ORACLE_HOME=/u01/app/12.1.0.2/db)
     (SID_NAME = CDB1)
   )
 )
 </pre>
<p>Reload listener on standby machine:</p>
<pre>
$ lsnrctl reload

LSNRCTL for Linux: Version 12.1.0.2.0 - Production on 24-DEC-2014 14:20:02

Copyright (c) 1991, 2014, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=ol6twsa1)(PORT=1521)))
The command completed successfully
</pre>
<p>Check that aux service is registered and linked to auxiliary standby instance (even if standby instance is not yet started):</p>
<pre>
$ lsnrctl status

LSNRCTL for Linux: Version 12.1.0.2.0 - Production on 24-DEC-2014 14:20:06

Copyright (c) 1991, 2014, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=ol6twsa1)(PORT=1521)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 12.1.0.2.0 - Production
Start Date                24-DEC-2014 10:21:38
Uptime                    0 days 3 hr. 58 min. 27 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /u01/app/12.1.0.2/grid/network/admin/listener.ora
Listener Log File         /u01/app/oracle/diag/tnslsnr/ol6twsa1/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=ol6twsa1)(PORT=1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))
Services Summary...
Service "+ASM" has 1 instance(s).
  Instance "+ASM", status READY, has 1 handler(s) for this service...
Service "AUX" has 1 instance(s).
  Instance "CDB1", status UNKNOWN, has 1 handler(s) for this service...
The command completed successfully
</pre>
<h3>Create PFILE for standby database instance</h3>
<p>This PFILE is used by the standby auxiliary instance and must be created in Oracle Database home:</p>
<pre>
$ cat $ORACLE_HOME/dbs/initCDB1.ora
db_name=AUX
</pre>
<p>Start standby auxiliary instance:</p>
<pre>
$ export ORACLE_SID=CDB1
$ sqlplus / as sysdba

SQL*Plus: Release 12.1.0.2.0 Production on Wed Dec 24 14:24:50 2014

Copyright (c) 1982, 2014, Oracle.  All rights reserved.

Connected to an idle instance.

SYS@CDB1&gt;startup nomount;
ORACLE instance started.

Total System Global Area  218103808 bytes
Fixed Size                  2922712 bytes
Variable Size             159385384 bytes
Database Buffers           50331648 bytes
Redo Buffers                5464064 bytes
SYS@CDB1&gt;Disconnected from Oracle Database 12c Enterprise Edition Release 12.1.0.2.0 - 64bit Production
With the Partitioning, OLAP, Advanced Analytics and Real Application Testing options
$
</pre>
<h3>Create needed AUDIT_FILE_DEST directory</h3>
<p>It will be set to primary instance AUDIT_FILE_DEST by RMAN DUPLICATE (this also assumes that ORACLE_BASE has the same setting on both machines):</p>
<pre>
$ mkdir -p /u01/app/oracle/admin/CDB0/adump
</pre>
<h3>Prepare RMAN DUPLICATE script on standby machine</h3>
<pre>
$ cat dup.ksh
#
set -x
#
rman &lt;&lt;EOR
set echo on
connect target sys/oracle12c@CDB0
connect auxiliary sys/oracle12c@AUX
run {
 duplicate target database for standby from active database
 spfile
 set 'db_unique_name'='CDB1'
 set 'compatible'='12.1.0.2';
}
EOR
</pre>
<h3>Start RMAN DUPLICATE script </h3>
<p>If you expect duplication to take a lot of time, this script should be run in background with at or nohup.</p>
<pre>
$ ./dup.ksh
</pre>
<p>This RMAN script must end with similar output:</p>
<pre>
Finished Duplicate Db at DD-MON-YY


RMAN&gt;

Recovery Manager complete.
</pre>
<p>Detailed output is <a href="http://pierreforstmanndotcom.wordpress.com/rman_dup_24122014-log">here</a>.</p>
<h3>Set LOG_ARCHIVE_DEST_2, FAL_SERVER and FAL_CLIENT on standby database</h3>
<pre>
SYS@CDB1&gt;alter system set log_archive_dest_2='service=CDB0 lgwr sync valid_for=(online_logfiles,primary_role) db_unique_name=CDB0';

System altered.

SYS@CDB1&gt;alter system set fal_server='CDB0';

System altered.

SYS@CDB1&gt;alter system set fal_client='CDB1';

System altered.

SYS@CDB1&gt;

</pre>
<h3> Start redo apply in real time mode on standby instance </h3>
<pre>
SYS@CDB1&gt;alter database recover managed standby database using current logfile disconnect;

Database altered.
</pre>
<p>Check that standby instance alert log has similar output:</p>
<pre>
Wed Dec 24 14:40:43 2014
Warning: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE has been deprecated.
Warning: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE has been deprecated.
alter database recover managed standby database using current logfile disconnect
Wed Dec 24 14:40:43 2014
Attempt to start background Managed Standby Recovery process (CDB1)
Starting background process MRP0
Wed Dec 24 14:40:43 2014
MRP0 started with pid=25, OS id=5635
Wed Dec 24 14:40:43 2014
MRP0: Background Managed Standby Recovery process started (CDB1)
Wed Dec 24 14:40:48 2014
Serial Media Recovery started
Managed Standby Recovery starting Real Time Apply
Wed Dec 24 14:40:48 2014
Waiting for all non-current ORLs to be archived...
Wed Dec 24 14:40:48 2014
All non-current ORLs have been archived.
Media Recovery Waiting for thread 1 sequence 9
Completed: alter database recover managed standby database using current logfile disconnect
</pre>
<p>Now you can enable redo transfer from primary database instance:</p>
<pre>
SYS@CDB0&gt;alter system set log_archive_dest_state_2=enable;

System altered.

SYS@CDB0&gt;

</pre>
<p>Primary instance alert log should have similar output:</p>
<pre>
Wed Dec 24 14:42:05 2014
ALTER SYSTEM SET log_archive_dest_state_2='ENABLE' SCOPE=BOTH;
Wed Dec 24 14:42:08 2014
Destination LOG_ARCHIVE_DEST_2 is UNSYNCHRONIZED
******************************************************************
LGWR: Setting 'active' archival for destination LOG_ARCHIVE_DEST_2
******************************************************************
Starting background process NSS2
Wed Dec 24 14:42:08 2014
NSS2 started with pid=27, OS id=9437
LGWR: Standby redo logfile selected for thread 1 sequence 11 for destination LOG_ARCHIVE_DEST_2
Wed Dec 24 14:42:12 2014
Thread 1 advanced to log sequence 11 (LGWR switch)
  Current log# 2 seq# 11 mem# 0: +DATA/CDB0/ONLINELOG/group_2.259.867160241
  Current log# 2 seq# 11 mem# 1: +FRA/CDB0/ONLINELOG/group_2.269.867160241
Wed Dec 24 14:42:13 2014
Archived Log entry 3 added for thread 1 sequence 10 ID 0x351521a7 dest 1:
Wed Dec 24 14:42:14 2014
ARC1: Standby redo logfile selected for thread 1 sequence 10 for destination LOG_ARCHIVE_DEST_2
</pre>
<p>Standby instance alert log should have similar output:</p>
<pre>
Wed Dec 24 14:42:14 2014
Network Resource Management enabled for Process  (pid 5660) for Exadata I/O
Primary database is in MAXIMUM PERFORMANCE mode
RFS[1]: Assigned to RFS process (PID:5660)
RFS[1]: Selected log 4 for thread 1 sequence 11 dbid 890600873 branch 867160237
Wed Dec 24 14:42:15 2014
RFS[2]: Assigned to RFS process (PID:5658)
RFS[2]: Opened log for thread 1 sequence 9 dbid 890600873 branch 867160237
Wed Dec 24 14:42:16 2014
Archived Log entry 1 added for thread 1 sequence 9 rlc 867160237 ID 0x351521a7 dest 2:
Wed Dec 24 14:42:17 2014
RFS[3]: Assigned to RFS process (PID:5663)
RFS[3]: Selected log 5 for thread 1 sequence 10 dbid 890600873 branch 867160237
Wed Dec 24 14:42:17 2014
Media Recovery Log +FRA/CDB1/ARCHIVELOG/2014_12_24/thread_1_seq_9.271.867163335
Wed Dec 24 14:42:18 2014
Archived Log entry 2 added for thread 1 sequence 10 ID 0x351521a7 dest 1:
Wed Dec 24 14:42:18 2014
Media Recovery Log +FRA/CDB1/ARCHIVELOG/2014_12_24/thread_1_seq_10.270.867163339
Media Recovery Waiting for thread 1 sequence 11 (in transit)
Wed Dec 24 14:42:20 2014
Recovery of Online Redo Log: Thread 1 Group 4 Seq 11 Reading mem 0
  Mem# 0: +DATA/CDB1/ONLINELOG/group_4.275.867163081
  Mem# 1: +FRA/CDB1/ONLINELOG/group_4.261.867163081
</pre>
<p>Test datafile creation on primary instance with:</p>
<pre>
SYS@CDB0&gt;create tablespace ts1443;

Tablespace created.
</pre>
<p>Check that on standby alert log that the datafile has been created:</p>
<pre>

Wed Dec 24 14:43:46 2014
Successfully added datafile 5 to media recovery
Datafile #5: '+DATA/CDB1/DATAFILE/ts1443.272.867163423'

</pre>
<h3> Add standby database to GI configuration </h3>
<pre>
$ srvctl add database -db CDB1 -oraclehome $ORACLE_HOME -spfile $ORACLE_HOME/dbs/spfileCDB1.ora -role PHYSICAL_STANDBY -startoption MOUNT -dbname CDB1 -diskgroup DATA,FRA
</pre>
<h3>Switchover</h3>
<p><a href="http://www.mhprofessional.com/product.php?isbn=0071621113">Oracle Data Guard 11g Handbook</a> page 20 (written by several Oracle Corp. employees implementing the Data Guard product) describes switchover process the following way:</p>
<li>notifies the primary database that a switchover is about to occur.</li>
<li>disconnects all users from the primary.</li>
<li>generates a special redo record the signals the End Of Redo (EOR).</li>
<li>converts the primary database into a standby database.</li>
<li>once the standby database applies the final EOR record, guaranteeing that no data has been lost, convers the standby to the primary role.</li>
<p>There no data loss with switchover i.e. no transaction committed on the primary before the EOR is lost: it must be applied on the standby otherwise switchover cannot successfully complete.</p>
<p>I have used the <a href="http://docs.oracle.com/database/121/SBYDB/role_management.htm#SBYDB5170">new 12.1 statements for switchover</a>.<br />
<br />
To avoid ORA-16475 in switchover verification step you must set LOG_ARCHIVE_DEST_STATE_2 on standby to ENABLE:</p>
<pre>
SYS@CDB1&gt;alter system set log_archive_dest_state_2=enable;

System altered.
</pre>
<h3>STEP 1: on primary instance, verify if switchover is possible</h3>
<pre>
SYS@CDB0&gt;alter database switchover to CDB1 verify;

Database altered.

SYS@CDB0&gt;
</pre>
<p>Primary instance alert log says:</p>
<pre>
Wed Dec 24 14:56:23 2014
SWITCHOVER VERIFY: Send VERIFY request to switchover target CDB1
SWITCHOVER VERIFY COMPLETE
Completed: alter database switchover to CDB1 verify
</pre>
<p>Standby instance alert log says:</p>
<pre>
Wed Dec 24 14:56:26 2014
SWITCHOVER VERIFY BEGIN
SWITCHOVER VERIFY COMPLETE
</pre>
<h3>STEP 2: on primary instance, switchover to standby</h3>
<pre>
SYS@CDB0&gt;alter database switchover to CDB1;

Database altered.

SYS@CDB0&gt;
</pre>
<p>Corresponding primary instance alert log output is <a href="http://pierreforstmanndotcom.wordpress.com/switch-s2-primary-24122014-log">here</a>.<br />
<br />
Corresponding standby instance alert log output is <a href="http://pierreforstmanndotcom.wordpress.com/switch-s2-standby-24122014-log">here</a>.</p>
<h3>STEP 3: open new primary database (former standby)</h3>
<pre>

SYS@CDB1&gt;alter database open;

Database altered.

SYS@CDB1&gt;
</pre>
<p>Corresponding new primary alert log output is <a href="http://pierreforstmanndotcom.wordpress.com/switch-s3-primary-24122014-log">here</a>.<br />
Note that connections errors to new standby are expected because new standby instance has been shutdown.<br />
</p>
<h3>STEP 4: restart new standby instance (former primary)</h3>
<pre>
SYS@CDB0&gt;startup mount;
ORACLE instance started.

Total System Global Area  641728512 bytes
Fixed Size                  2927672 bytes
Variable Size             562037704 bytes
Database Buffers           71303168 bytes
Redo Buffers                5459968 bytes
Database mounted.
SYS@CDB0&gt;
</pre>
<p>Corresponding new standby alert log is <a href="http://pierreforstmanndotcom.wordpress.com/switch-s4-standby-24122014-log">here</a>.<br />
<br />
Corresponding new primary alert log is <a href="http://pierreforstmanndotcom.wordpress.com/switch-s4-primary-24122014-log">here</a>.<br />
Note that you can ignore ORA-12514 ans TNS-12564 errors.</p>
<h3>STEP 5: start redo apply on new standby</h3>
<pre>
SYS@CDB0&gt;alter database recover managed standby database using current logfile disconnect;

Database altered.

SYS@CDB0&gt;
</pre>
<p>Corresponding new standby alert log <a href="http://pierreforstmanndotcom.wordpress.com/switch-s5-standby-24122014-log">here</a>.</p>
<p>Switchover has been successfully completed: you can also confirm this by checking V$DATABASE.<br />
<br />
On new primary:</p>
<pre>
SYS@CDB1&gt;select name, db_unique_name, database_role, protection_mode from v$database;

NAME      DB_UNIQUE_NAME                 DATABASE_ROLE    PROTECTION_MODE
--------- ------------------------------ ---------------- --------------------
CDB0      CDB1                           PRIMARY          MAXIMUM PERFORMANCE

SYS@CDB1&gt;
</pre>
<p>On new standby:</p>
<pre>
SYS@CDB0&gt;select name, db_unique_name, database_role, protection_mode from v$database;

NAME      DB_UNIQUE_NAME                 DATABASE_ROLE    PROTECTION_MODE
--------- ------------------------------ ---------------- --------------------
CDB0      CDB0                           PHYSICAL STANDBY MAXIMUM PERFORMANCE

SYS@CDB0&gt;
</pre>
<p>Next steps should be:</p>
<li>deciding what database protection you need and to change it if needed</li>
<li>deciding whether you want to manage Data Guard only with SQL statements or use Data Guard Broker</li>
<li>deciding whether you want to use Flashback database option (useful to rebuild primary database in case of failover)</li>
<li>deciding whether standby database should be backed up or not</li>
<li>deciding how to purge archived redo logs on standby.</li>
