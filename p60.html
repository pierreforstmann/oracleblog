<p>Beginning of November 2016 Oracle Corp. has made available more DBAAS offerings for Oracle 12.2.0.1. and <a href="http://docs.oracle.com/database/122/nav/portal_booklist.htm">Oracle 12c release 2 database documentation</a>. But you still cannot download Oracle 12.2.0.1 installation media.</p>
<p>I have used free trial to create an Oracle Database Cloud Service: this is a virtual machine where Oracle Database software is pre-installed and a database is created using web interface. This is the only service in free trial at the time of writing that allows to use Oracle 12.2.0.1 (the Oracle Database Cloud Service - Virtual Image currently allows only to work with Oracle 11.2.0.4 and Oracle 12.1.0.2).</p>
<p>In this article I want only to use DBCA to create a new 12.2.0.1 non-container database in order to compare DBCA 12.1 and DBCA 12.2.</p>
<p>Note that are other ways to create a DBAAS database in command line mode for example <a href="http://blog.dbi-services.com/oracle-public-cloud-create-a-database-from-command-line/" />using CURL and DBAAS REST API thanks to Franck Pachot </a>.<br />
</p>
<h2>Trying to create a new database with default DBCA templates</h2>
<p>I didn't manage to create a database with default DBCA templates.</p>
<p>If I use the seed template <b>General_Purpose.dbc</b> I get:</p>
<pre>
ORA-01092: ORACLE instance terminated. Disconnection forced
ORA-28427: cannot create, import or restore unencrypted tablespace: USERS in Oracle Cloud
</pre>
<p>If I use the non seed template <b>New_Database.dbt</b> I get:</p>
<pre>
CREATE SMALLFILE UNDO TABLESPACE UNDOTBS1 DATAFILE   '/data/NCDB/undotbs01.dbf' SIZE 200M REUSE AUTOEXTEND ON NEXT  5120K MAXSIZE UNLIMITED

Force tablespace UNDOTBS1 to be encrypted with AES128
ORA-28365 signalled during: CREATE SMALLFILE UNDO TABLESPACE UNDOTBS1 DATAFILE   '/data/NCDB/undotbs01.dbf' SIZE 200M REUSE AUTOEXTEND ON NEXT  5120K MAXSIZE UNLIMITED

...
2016-11-12T19:20:33.193157+00:00
Errors in file /u01/app/oracle/diag/rdbms/ncdb/NCDB/trace/NCDB_ora_16029.trc:
ORA-00604: error occurred at recursive SQL level 1
ORA-28365: wallet is not open
2016-11-12T19:20:33.193289+00:00
Errors in file /u01/app/oracle/diag/rdbms/ncdb/NCDB/trace/NCDB_ora_16029.trc:
ORA-01501: CREATE DATABASE failed
ORA-01519: error while processing file '?/rdbms/admin/dtxnspc.bsq' near line 6
ORA-00604: error occurred at recursive SQL level 1
ORA-28365: wallet is not open
</pre>
<p>I have checked the default database ORCL created with the VM:</p>
<pre>
SQL&gt; select name from v$database;

NAME
---------
ORCL

SQL&gt; select * from v$version;

BANNER                                                                               CON_ID
-------------------------------------------------------------------------------- ----------
Oracle Database 12c Enterprise Edition Release 12.2.0.1.0 - 64bit Production              0
PL/SQL Release 12.2.0.1.0 - Production                                                    0
CORE    12.2.0.1.0      Production                                                                0
TNS for Linux: Version 12.2.0.1.0 - Production                                            0
NLSRTL Version 12.2.0.1.0 - Production                                                    0

SQL&gt; select tablespace_name, encrypted from dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO
UNDOTBS1                       NO
TEMP                           NO
USERS                          YES

</pre>
<p>This is due to a new 12.2 instance parameter <a href="http://docs.oracle.com/database/122/REFRN/ENCRYPT_NEW_TABLESPACES.htm#REFRN-GUID-44EF2AAC-1313-4437-B0F3-A427F45016F2">ENCRYPT_NEW_TABLESPACES</a> (which was a hidden parameter in 12.1.0.2 according to <a href="https://blogs.oracle.com/pshuff/entry/database_options_advanced_security">Pat Shuff's blog</a> and <a href="https://blogs.oracle.com/UPGRADE/entry/tde_is_wonderful_journey_to">Mike Dietrich's blog</a>):</p>
<pre>
SQL&gt; show parameter encrypt

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
encrypt_new_tablespaces              string      CLOUD_ONLY
</pre>
<p>I understand that all application tablespaces must be encrypted if database runs in Oracle Cloud.</p>
<h2>Trying to create manually a database (i.e. without DBCA)</h2>
<p> I have managed to create manually a 12.2.0.1 non-container database with non encrypted tablespaces using following script:</p>
<pre>
#!/bin/sh
export ORACLE_SID=TEST
export PFILE=$ORACLE_HOME/dbs/initTEST.ora
#
echo "db_name=TEST" &gt; $PFILE 
echo "db_create_file_dest=/u02" &gt;&gt; $PFILE
echo "db_recovery_file_dest=/u04" &gt;&gt; $PFILE
echo "db_recovery_file_dest_size=10G" &gt;&gt; $PFILE
echo "memory_target=2G" &gt;&gt; $PFILE
echo "encrypt_new_tablespaces=DDL" &gt;&gt; $PFILE
#
sqlplus / as sysdba &lt;&lt; EOF
shutdown abort
startup nomount 
create spfile from pfile;
host rm $PFILE
shutdown abort
startup nomount
create database;
@?/rdbms/admin/catalog.sql
@?/rdbms/admin/catproc.sql
@?/rdbms/admin/utlrp.sql
EOF 
</pre>
<p>I have created a non encrypted tablespace with:</p>
<pre>
create tablespace data;
</pre>
<p>But at next database instance stop/start, instance does not start even if ENCRYPT_NEW_TABLESPACES is set to DDL:</p>
<pre>
SQL&gt; startup
ORACLE instance started.

Total System Global Area 2147483648 bytes
Fixed Size                  8622776 bytes
Variable Size            1207962952 bytes
Database Buffers          922746880 bytes
Redo Buffers                8151040 bytes
Database mounted.
ORA-00603: ORACLE server session terminated by fatal error
ORA-01092: ORACLE instance terminated. Disconnection forced
ORA-28427: cannot create, import or restore unencrypted tablespace: DATA in Oracle Cloud
Process ID: 9042
Session ID: 162 Serial number: 57458
</pre>
<h2> The right way to create manually a database in Oracle Cloud</h2>
<p>I have now understood that the right way to create a database with CREATE DATABASE in Oracle Cloud is to:</p>
<li>
1: create a database without any application tablespace because SYSTEM, SYSAUX and undo tablespaces don't need to be encrypted in Oracle Cloud
</li>
<li>
2: setup Transparent Data Encryption (TDE)
</li>
<li>
3: create application tablespace that can be encrypted
</li>
<h3>Step 1: create a minimum database</h3>
<p>I have run following script:</p>
<pre>
#!/bin/sh
export ORACLE_SID=NCDB
export PFILE=$ORACLE_HOME/dbs/initNCDB.ora
rm -rf /u02/NCDB
rm -rf /u04/NCDB
rm -f $ORACLE_HOME/dbs/spfileNCDB.ora
#
echo "db_name=TPL" &gt; $PFILE 
echo "db_create_file_dest=/u02" &gt;&gt; $PFILE
echo "db_recovery_file_dest=/u04" &gt;&gt; $PFILE
echo "db_recovery_file_dest_size=10G" &gt;&gt; $PFILE
echo "memory_target=2G" &gt;&gt; $PFILE
echo "encrypt_new_tablespaces=DDL" &gt;&gt; $PFILE
#
sqlplus / as sysdba &lt;&lt; EOF
shutdown abort
startup nomount 
create spfile from pfile;
host rm $PFILE
shutdown abort
startup nomount
spool crdb.log
create database NCDB character set al32utf8;
@?/rdbms/admin/catalog.sql
@?/rdbms/admin/catproc.sql
@?/rdbms/admin/utlrp.sql
EOF
</pre>
<p>Running this script has created a non-container database with Unicode character set without any database option (except XML database) and with only "system" tablespaces that are not encrypted:</p>
<pre>
QL&gt;  select name, cdb from v$database;

NAME      CDB
--------- ---
NCDB      NO

SQL&gt; select tablespace_name, encrypted from dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO
SYS_UNDOTS                     NO

SQL&gt; select comp_name, version, status from dba_registry;


COMP_NAME                                VERSION    STATUS
---------------------------------------- ---------- -----------
Oracle Database Catalog Views            12.2.0.1.0 VALID
Oracle Database Packages and Types       12.2.0.1.0 VALID
Oracle XML Database                      12.2.0.1.0 VALID
</pre>
<h3>step 2: setup TDE </h3>
<p>To setup TDE for my new database I have used and adapted <a href="http://www.toadworld.com/platforms/oracle/w/wiki/11140.oracle-database-12c-transparent-data-encryption-tde-and-the-world-of-multitenant-database"> Oracle Database 12c: Transparent Data Encryption (TDE) and the world of multitenant database</a> from Toad World by Abu Fazal Abbas.</p>
<p>First I have modified sqlnet.ora so that each database has its own TDE directories:</p>
<pre>
$ grep SID $ORACLE_HOME/network/admin/sqlnet.ora
ENCRYPTION_WALLET_LOCATION = (SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=/u01/app/oracle/admin/$ORACLE_SID/tde_wallet)))
WALLET_LOCATION = (SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=/u01/app/oracle/admin/$ORACLE_SID/db_wallet)))
$ 
</pre>
<p>I have created TDE wallet directory for NCDB database:</p>
<pre>
$ mkdir /u01/app/oracle/admin/NCDB/tde_wallet
</pre>
<p>I have connected to NCDB and run following SQL statements:</p>
<pre>
SQL&gt; administer key management create keystore '/u01/app/oracle/admin/NCDB/tde_wallet' identified by xxx;

keystore altered.

SQL&gt; administer key management set keystore open identified by xxx; 

keystore altered.

SQL&gt; select * from v$encryption_wallet;

WRL_TYPE
--------------------
WRL_PARAMETER
--------------------------------------------------------------------------------
STATUS                         WALLET_TYPE          WALLET_OR FULLY_BAC
------------------------------ -------------------- --------- ---------
    CON_ID
----------
FILE
/u01/app/oracle/admin/NCDB/tde_wallet/
OPEN_NO_MASTER_KEY             PASSWORD             SINGLE    UNDEFINED
         0


SQL&gt;  administer key management create auto_login keystore from keystore '/u01/app/oracle/admin/NCDB/tde_wallet' identified by xxx;

keystore altered.

SQL&gt; 
SQL&gt; administer key management set key identified by mks with backup;

keystore altered.

SQL&gt; 

SQL&gt; select con_id, key_id, keystore_type from v$encryption_keys;

    CON_ID
----------
KEY_ID
------------------------------------------------------------------------------
KEYSTORE_TYPE
-----------------
         0
AdOGu2sWO085v33seosS01IAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
SOFTWARE KEYSTORE


SQL&gt; select * from v$encryption_wallet;

WRL_TYPE
--------------------
WRL_PARAMETER
--------------------------------------------------------------------------------
STATUS                         WALLET_TYPE          WALLET_OR FULLY_BAC
------------------------------ -------------------- --------- ---------
    CON_ID
----------
FILE
/u01/app/oracle/admin/NCDB/tde_wallet/
OPEN                           PASSWORD             SINGLE    NO
         0

</pre>
<h3>Step 3: create application tablespace</h3>
<p>I have run:</p>
<pre>
SQL&gt; show parameter new

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
encrypt_new_tablespaces              string      DDL
SQL&gt; alter system set encrypt_new_tablespaces=cloud_only;

System altered.

SQL&gt; create tablespace data;

Tablespace created.

SQL&gt; select tablespace_name, encrypted from dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO
SYS_UNDOTS                     NO
DATA                           YES
</pre>
<p>To check that everything works as expected I have also tested database instance restart:</p>
<pre>
SQL&gt; shutdown immediate
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL&gt; startup
ORACLE instance started.

Total System Global Area 2147483648 bytes
Fixed Size                  8622776 bytes
Variable Size            1224740168 bytes
Database Buffers          905969664 bytes
Redo Buffers                8151040 bytes
Database mounted.
Database opened.
SQL&gt;       
</pre>
<p>I have noted that alert log says:</p>
<pre>
Verifying minimum file header compatibility for tablespace encryption..
Verifying file header compatibility for tablespace encryption completed for pdb 0
Database Characterset is AL32UTF8
No Resource Manager plan active
Verifying all user tablespaces in pdb 0 are encrypted in Oracle Cloud..
All user tablespaces in pdb 0 are encrypted
</pre>
<h2>Conclusions</h2>
<p>What I have learned from all this tests:</p>
<li>
I don't think that it is possible to create a database using DBCA and its default DBCA templates in Oracle Cloud DBAAS.
</li>
<li>
Each database created in Oracle Cloud <b><u>MUST</b></u> have each application tablespace encrypted.
</li>
<li>
Oracle database server code is checking whether it runs on Oracle Cloud or not and behaves differently if instance parameter ENCRYPT_NEW_TABLESPACES is set to CLOUD_ONLY: in other words Oracle server code may not behave the same way in Oracle cloud and on premises.
</li>
